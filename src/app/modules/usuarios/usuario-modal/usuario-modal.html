<!-- ====== VISTA DETALLE (drawer) ====== -->
<ng-container *ngIf="isView; else createEditTpl">
  <div class="modal-backdrop" (click)="cancel()"></div>
  <div class="container drawer" (click)="cancel()">
    <div class="panel" (click)="$event.stopPropagation()">
      <div class="panel-head">
        <h2>Detalle de usuario</h2>
        <button class="icon" (click)="cancel()" aria-label="Cerrar">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="view">
        <div class="avatar">
          <img *ngIf="photoPreview; else ph" [src]="photoPreview" (error)="onImgError()" alt="Foto" />
          <ng-template #ph><div class="placeholder">{{ initialLetter }}</div></ng-template>
        </div>

        <dl>
          <div><dt>Nombre</dt><dd>{{usuario?.primerNombre}} {{usuario?.segundoNombre}}</dd></div>
          <div><dt>Apellido</dt><dd>{{usuario?.primerApellido}} {{usuario?.segundoApellido}}</dd></div>
          <div><dt>Usuario</dt><dd class="mono">{{usuario?.username}}</dd></div>
          <div><dt>Rol</dt><dd>{{ $any(usuario)?.rol?.nombre || '—' }}</dd></div>
          <div><dt>Teléfono</dt><dd>{{usuario?.celular}}</dd></div>
          <div><dt>Estado</dt><dd>{{usuario?.estado}}</dd></div>
          <div><dt>NIT</dt><dd>{{usuario?.nit}}</dd></div>
          <div><dt>CUI</dt><dd>{{usuario?.cui}}</dd></div>
          <div><dt>Email</dt><dd>{{usuario?.email}}</dd></div>
          <div><dt>Dirección</dt><dd>{{usuario?.direccion}}</dd></div>
        </dl>

        <div class="panel-actions">
          <button class="ghost" (click)="cancel()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- ====== CREAR / EDITAR (modal) ====== -->
<ng-template #createEditTpl>
  <div class="modal-backdrop" (click)="cancel()"></div>

  <section class="modal" role="dialog" aria-modal="true" aria-labelledby="um-title" (click)="cancel()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <header class="modal-head">
        <div class="modal-title-wrap">
          <div *ngIf="isEdit" class="avatar tiny">
            <ng-template #eph><div class="placeholder">{{ initialLetter }}</div></ng-template>
          </div>
          <span class="modal-dot"></span>
          <h2 id="um-title">{{ isCreate ? 'Nuevo usuario' : 'Editar usuario' }}</h2>
        </div>
        <button class="icon close" type="button" (click)="cancel()" aria-label="Cerrar">
          <span class="material-icons">close</span>
        </button>
      </header>

      <form class="form four-col" [formGroup]="form" (ngSubmit)="save()">
        <!-- 1 -->
        <label>
          Primer nombre*
          <input formControlName="primerNombre" />
          <small class="error" *ngIf="showCtrlError('primerNombre')">Entre 2 y 50 caracteres.</small>
        </label>
        <label>
          Segundo nombre
          <input formControlName="segundoNombre" />
          <small class="hint">Opcional. Máx. 50.</small>
        </label>
        <label>
          Primer apellido*
          <input formControlName="primerApellido" />
          <small class="error" *ngIf="showCtrlError('primerApellido')">Entre 2 y 50 caracteres.</small>
        </label>
        <label>
          Segundo apellido
          <input formControlName="segundoApellido" />
          <small class="hint">Opcional. Máx. 50.</small>
        </label>

        <!-- 2 -->
        <label>
          NIT*
          <input formControlName="nit" inputmode="numeric" maxlength="9" placeholder="#########" />
          <small class="hint">Exactamente 9 dígitos (sin guiones).</small>
          <small class="error" *ngIf="showCtrlError('nit')">Debe contener 9 dígitos.</small>
        </label>
        <label>
          CUI*
          <input formControlName="cui" inputmode="numeric" maxlength="13" placeholder="#############" />
          <small class="hint">Exactamente 13 dígitos.</small>
          <small class="error" *ngIf="showCtrlError('cui')">Debe contener 13 dígitos.</small>
        </label>
        <label>
          Fecha nacimiento*
          <input type="date" formControlName="fechaNacimiento" [min]="minNac" [max]="maxNac" />
          <small class="hint">≥ {{minNac}} y ≤ {{maxNac}} (mín. 15 años).</small>
          <small class="error" *ngIf="form.hasError('fnOutOfRange') && (getCtrl('fechaNacimiento').touched || getCtrl('fechaNacimiento').dirty)">
            La fecha de nacimiento está fuera de rango.
          </small>
        </label>
        <label>
          Fecha ingreso*
          <input type="date" formControlName="fechaIngreso" [min]="minIng" [max]="maxIng" />
          <small class="hint">Entre {{minIng}} y {{maxIng}}.</small>
          <small class="error" *ngIf="(form.hasError('fiOutOfRange') || form.hasError('fiBeforeMinAge')) && (getCtrl('fechaIngreso').touched || getCtrl('fechaIngreso').dirty)">
            {{ form.hasError('fiOutOfRange') ? 'La fecha de ingreso está fuera de rango.' : 'La fecha de ingreso debe ser al menos 15 años posterior a la de nacimiento.' }}
          </small>
        </label>

        <!-- 3 -->
        <label>
          Género*
          <select formControlName="genero">
            <option>Masculino</option><option>Femenino</option><option>Otro</option><option>Prefiero no decir</option>
          </select>
        </label>
        <label>
          Estado*
          <select formControlName="estado">
            <option>Activo</option><option>Inactivo</option><option>Suspendido</option>
          </select>
        </label>
        <label>
          Celular*
          <input formControlName="celular" inputmode="numeric" maxlength="8" placeholder="########" />
          <small class="hint">8 dígitos; debe iniciar con 2–7.</small>
          <small class="error" *ngIf="showCtrlError('celular')">Formato inválido.</small>
        </label>
        <label>
          Email*
          <input type="email" formControlName="email" />
          <small class="hint">Debe ser un correo válido.</small>
          <small class="error" *ngIf="showCtrlError('email')">Correo inválido.</small>
        </label>

        <!-- 4 -->
        <label class="span-4">
          Dirección*
          <input formControlName="direccion" />
          <small class="hint">Entre 10 y 120 caracteres.</small>
          <small class="error" *ngIf="showCtrlError('direccion')">Longitud inválida.</small>
        </label>

        <!-- 5: Rol + (Contraseña y Confirmación en la MISMA línea) -->
        <label class="span-2">
          Rol*
          <select formControlName="rolId">
            <option [ngValue]="null" disabled>Seleccione…</option>
            <option *ngFor="let r of roles" [ngValue]="r.id">{{ r.nombre }}</option>
          </select>
          <small class="error" *ngIf="showCtrlError('rolId')">Seleccione un rol.</small>
        </label>

        <!-- CREATE: par de contraseñas lado a lado -->
        <div *ngIf="isCreate" class="span-2 pwd-pair">
          <label class="inline">
            Contraseña*
            <div class="input-wrap">
              <input [type]="showPwd ? 'text' : 'password'" formControlName="password" />
              <button type="button" class="icon-btn" (click)="showPwd=!showPwd" aria-label="Mostrar/ocultar contraseña">
                <span class="material-icons">{{ showPwd ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
            <ul class="pwd-checklist grid">
              <li class="item" [class.ok]="pwdRules.len"><span class="material-icons status">{{ pwdRules.len ? 'check_circle' : 'radio_button_unchecked' }}</span> 8–64 caracteres</li>
              <li class="item" [class.ok]="pwdRules.upper"><span class="material-icons status">{{ pwdRules.upper ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 mayúscula</li>
              <li class="item" [class.ok]="pwdRules.lower"><span class="material-icons status">{{ pwdRules.lower ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 minúscula</li>
              <li class="item" [class.ok]="pwdRules.digit"><span class="material-icons status">{{ pwdRules.digit ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 número</li>
              <li class="item" [class.ok]="pwdRules.symbol"><span class="material-icons status">{{ pwdRules.symbol ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 símbolo</li>
            </ul>
            <small class="error" *ngIf="showCtrlError('password')">No cumple los requisitos.</small>
          </label>

          <label class="inline">
            Confirmar contraseña*
            <div class="input-wrap">
              <input [type]="showPwd2 ? 'text' : 'password'" formControlName="password2" />
              <button type="button" class="icon-btn" (click)="showPwd2=!showPwd2" aria-label="Mostrar/ocultar confirmación">
                <span class="material-icons">{{ showPwd2 ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
            <small class="error" *ngIf="showCtrlError('password2')">Confirmación de contraseña obligatoria.</small>
            <small class="error" *ngIf="form.hasError('pwdMismatch') && (getCtrl('password2').dirty || getCtrl('password2').touched)">
              Las contraseñas no coinciden.
            </small>
          </label>
        </div>

        <!-- EDIT: switch + par de contraseñas lado a lado -->
        <div *ngIf="isEdit" class="span-2 change-pwd">
          <label class="switch">
            <input id="chgPwd" type="checkbox" [checked]="changePwd" (change)="toggleChangePwd()" />
            <span class="track" aria-hidden="true"><span class="thumb"></span></span>
            <span class="switch-label">Cambiar contraseña</span>
          </label>
        </div>

        <div *ngIf="isEdit && changePwd" class="span-2 pwd-pair">
          <label class="inline">
            Nueva contraseña*
            <div class="input-wrap">
              <input [type]="showPwd ? 'text' : 'password'" formControlName="password" />
              <button type="button" class="icon-btn" (click)="showPwd=!showPwd" aria-label="Mostrar/ocultar contraseña">
                <span class="material-icons">{{ showPwd ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
            <ul class="pwd-checklist grid">
              <li class="item" [class.ok]="pwdRules.len"><span class="material-icons status">{{ pwdRules.len ? 'check_circle' : 'radio_button_unchecked' }}</span> 8–64 caracteres</li>
              <li class="item" [class.ok]="pwdRules.upper"><span class="material-icons status">{{ pwdRules.upper ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 mayúscula</li>
              <li class="item" [class.ok]="pwdRules.lower"><span class="material-icons status">{{ pwdRules.lower ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 minúscula</li>
              <li class="item" [class.ok]="pwdRules.digit"><span class="material-icons status">{{ pwdRules.digit ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 número</li>
              <li class="item" [class.ok]="pwdRules.symbol"><span class="material-icons status">{{ pwdRules.symbol ? 'check_circle' : 'radio_button_unchecked' }}</span> 1 símbolo</li>
            </ul>
            <small class="error" *ngIf="showCtrlError('password')">No cumple los requisitos.</small>
          </label>

          <label class="inline">
            Confirmar contraseña*
            <div class="input-wrap">
              <input [type]="showPwd2 ? 'text' : 'password'" formControlName="password2" />
              <button type="button" class="icon-btn" (click)="showPwd2=!showPwd2" aria-label="Mostrar/ocultar confirmación">
                <span class="material-icons">{{ showPwd2 ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
            <small class="error" *ngIf="showCtrlError('password2')">Confirmación de contraseña obligatoria.</small>
            <small class="error" *ngIf="form.hasError('pwdMismatch') && (getCtrl('password2').dirty || getCtrl('password2').touched)">
              Las contraseñas no coinciden.
            </small>
          </label>
        </div>

        <!-- 6 -->
        <label class="span-4">
          Foto
          <div class="file-row">
            <input type="file" (change)="onFile($event)" accept="image/*" />
            <div class="avatar preview">
              <img *ngIf="photoPreview; else fph" [src]="photoPreview" (error)="onImgError()" alt="Foto" />
              <ng-template #fph><div class="placeholder">{{ initialLetter }}</div></ng-template>
            </div>
          </div>
          <small class="hint">JPG, PNG o WEBP.</small>
        </label>

        <footer class="modal-foot">
          <div class="left">
            <button type="button" class="ghost" (click)="cancel()">Cancelar</button>
            <button *ngIf="isEdit && usuario" type="button" class="danger" (click)="removeInside()">
              <span class="material-icons" aria-hidden="true">delete</span> Eliminar
            </button>
          </div>
          <button type="submit" class="primary">Guardar</button>
        </footer>
      </form>
    </div>
  </section>
</ng-template>
