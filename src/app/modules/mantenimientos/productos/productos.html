<div class="prod-page page" [class.modal-open]="showCreate || showEdit">
  <!-- Título -->
  <div class="head-title">
    <h1>Productos</h1>
  </div>

  <!-- Head -->
  <div class="head">
    <div class="actions">
      <!-- Buscador -->
      <div class="search" aria-label="Buscar productos">
        <span class="material-icons" aria-hidden="true">search</span>
        <input
          type="text"
          placeholder="Buscar producto, código o categoría…"
          [value]="term()"
          (input)="onSearch($event)"
          autocomplete="off"/>
      </div>

      <!-- Segmentado -->
      <div class="segmented" role="group" aria-label="Filtrar por estado">
        <button type="button" class="seg"
                [class.active]="view()==='activos'"
                (click)="setView('activos')">
          Activos <span class="seg-badge">{{ activosCount() }}</span>
        </button>
        <button type="button" class="seg"
                [class.active]="view()==='inactivos'"
                (click)="setView('inactivos')">
          Inactivos <span class="seg-badge">{{ inactivosCount() }}</span>
        </button>
        <button type="button" class="seg"
                [class.active]="view()==='todos'"
                (click)="setView('todos')">
          Todos <span class="seg-badge">{{ filtered().length }}</span>
        </button>
      </div>

      <!-- Filtro por categoría -->
      <div class="filters">
        <select class="filter" [ngModel]="catId()" (ngModelChange)="setCategoria($event)">
          <option [ngValue]="0">Todas las categorías</option>
          <option *ngFor="let c of categorias(); trackBy: trackById" [ngValue]="c.id">{{ c.nombre }}</option>
        </select>
        <button class="ghost" type="button" (click)="clearCategoria()" [disabled]="catId()===0">Limpiar</button>
      </div>
    </div>

    <!-- Botón principal a la derecha -->
    <button class="primary" type="button" (click)="openCreate()">
      <span class="material-icons" aria-hidden="true">add</span>
      Nuevo producto
    </button>
  </div>

  <!-- Tabla -->
  <div class="card">
    <div class="table-wrapper" role="region" aria-live="polite" [attr.aria-busy]="loading() ? 'true' : null">
      <table class="grid" role="table" aria-label="Listado de productos">
        <thead>
          <tr>
            <th scope="col">Producto</th>
            <th scope="col">Código</th>
            <th scope="col">Categoría</th>
            <th scope="col">Presentación</th>
            <th scope="col">Estado</th>
            <th scope="col" class="acts-col">Acciones</th>
          </tr>
        </thead>

        <tbody *ngIf="!loading() && pageItems().length > 0; else tbEmpty">
          <tr *ngFor="let p of pageItems(); trackBy: trackByProdId">
            <td>
              <div class="prod">
                <img [src]="foto(p)" alt="imagen de {{p.nombre}}" loading="lazy">
                <div class="meta">
                  <div class="name">{{ p.nombre }}</div>
                  <div class="sub mono">{{ p.fotoUrl }}</div>
                </div>
              </div>
            </td>
            <td class="mono">{{ p.codigo }}</td>
            <td>{{ p.categoria }}</td>
            <td class="mono">{{ p.presentaciones }}</td>
            <td>
              <span class="state-pill" [ngClass]="p.activo ? 'activo' : 'inactivo'">
                {{ p.activo ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td>
              <div class="acts">
                <button class="icon" type="button" title="Editar" (click)="editar(p)">
                  <span class="material-icons" aria-hidden="true">edit</span>
                </button>
                <button class="icon danger" type="button" title="Eliminar" (click)="eliminar(p)">
                  <span class="material-icons" aria-hidden="true">delete</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>

        <ng-template #tbEmpty>
          <tbody>
            <tr>
              <td colspan="6">
                <div class="empty" *ngIf="!loading(); else tbLoading">
                  <span class="material-icons" aria-hidden="true">inventory_2</span>
                  <p>No hay productos que coincidan con los filtros.</p>
                </div>
              </td>
            </tr>
          </tbody>
        </ng-template>

        <ng-template #tbLoading>
          <div class="empty">
            <div class="spinner"></div>
            <p>Cargando…</p>
          </div>
        </ng-template>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pager" role="navigation" aria-label="Paginación" *ngIf="!loading() && total() > 0">
      <span class="pager-info">Página {{ page() }} de {{ pageCount() }}</span>
      <div class="spacer"></div>

      <button class="pager-btn" type="button" (click)="prev()" [disabled]="page()<=1">
        <span class="material-icons">chevron_left</span>
        <span>Anterior</span>
      </button>

      <button class="pager-btn" type="button" (click)="next()" [disabled]="page()>=pageCount()">
        <span>Siguiente</span>
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
  </div>

  <!-- ===== Modal: Crear ===== -->
  <div class="modal" *ngIf="showCreate" (click)="closeCreate()">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mdlCreateTitle" (click)="$event.stopPropagation()">
      <div class="modal-head">
        <strong id="mdlCreateTitle">Nuevo producto</strong>
        <button class="icon" type="button" (click)="closeCreate()" aria-label="Cerrar">
          <span class="material-icons" aria-hidden="true">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <label class="field"><span>Nombre</span><input type="text" [(ngModel)]="cNombre" /></label>
          <label class="field"><span>Categoría</span>
            <select [(ngModel)]="cCategoriaId">
              <option *ngFor="let c of categorias(); trackBy: trackById" [ngValue]="c.id">{{ c.nombre }}</option>
            </select>
          </label>
          <label class="field"><span>Proveedor</span>
            <select [(ngModel)]="cProveedorId">
              <option *ngFor="let p of proveedores(); trackBy: trackById" [ngValue]="p.id">{{ p.nombre }}</option>
            </select>
          </label>
          <label class="field"><span>Estado</span>
            <select [(ngModel)]="cActivo">
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </label>
          <label class="field"><span>Precio compra</span><input type="number" min="0" step="0.01" [(ngModel)]="cCompra" /></label>
          <label class="field"><span>Precio venta</span><input type="number" min="0" step="0.01" [(ngModel)]="cVenta" /></label>
        </div>

        <div class="uploader" (dragover)="$event.preventDefault()" (drop)="onDropCreate($event)">
          <img *ngIf="cPreview" class="preview" [src]="cPreview" alt="previsualización" />
          <button class="ghost" type="button" (click)="fileCreate.click()">Seleccionar imagen</button>
          <input #fileCreate type="file" accept="image/png,image/jpeg,image/webp" (change)="onFileCreate($event)" />
        </div>
      </div>

      <div class="modal-foot">
        <button class="ghost" type="button" (click)="closeCreate()">Cancelar</button>
        <button class="primary" type="button" (click)="crear()" [disabled]="saving">
          {{ saving ? 'Guardando…' : 'Crear producto' }}
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Modal: Editar ===== -->
  <div class="modal" *ngIf="showEdit" (click)="closeEdit()">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mdlEditTitle" (click)="$event.stopPropagation()">
      <div class="modal-head">
        <strong id="mdlEditTitle">Editar producto</strong>
        <button class="icon" type="button" (click)="closeEdit()" aria-label="Cerrar">
          <span class="material-icons" aria-hidden="true">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <label class="field"><span>Nombre</span><input type="text" [(ngModel)]="eNombre" /></label>
          <label class="field"><span>Categoría</span>
            <select [(ngModel)]="eCategoriaId">
              <option *ngFor="let c of categorias(); trackBy: trackById" [ngValue]="c.id">{{ c.nombre }}</option>
            </select>
          </label>
          <label class="field"><span>Precio compra</span><input type="number" min="0" step="0.01" [(ngModel)]="eCompra" /></label>
          <label class="field"><span>Precio venta</span><input type="number" min="0" step="0.01" [(ngModel)]="eVenta" /></label>
          <label class="field"><span>Estado</span>
            <select [(ngModel)]="eActivo">
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </label>
        </div>

        <div class="uploader" (dragover)="$event.preventDefault()" (drop)="onDropEdit($event)">
          <img *ngIf="ePreview || eFotoUrl" class="preview" [src]="ePreview || eFotoUrl" alt="foto actual" />
          <button class="ghost" type="button" (click)="fileEdit.click()">Cambiar imagen</button>
          <input #fileEdit type="file" accept="image/png,image/jpeg,image/webp" (change)="onFileEdit($event)" />
          <div *ngIf="eFotoUrl" class="file-path mono">{{ eFotoUrl }}</div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="ghost" type="button" (click)="closeEdit()">Cancelar</button>
        <button class="primary" type="button" (click)="guardarEdicion()" [disabled]="saving">
          {{ saving ? 'Guardando…' : 'Guardar cambios' }}
        </button>
      </div>
    </div>
  </div>
</div>
