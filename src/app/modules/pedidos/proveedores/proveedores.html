<div class="page pp-page" [class.modal-open]="showCreate || showRx || showQuick || showView">
  <div class="head-title">
    <h1>Compras a proveedores</h1>
  </div>

  <div class="head">
    <!-- Buscador -->
    <div class="search" aria-label="Buscar pedidos">
      <span class="material-icons" aria-hidden="true">search</span>
      <input
        #listSearch
        [ngModel]="q()"
        (ngModelChange)="q.set($event)"
        placeholder="Buscar por número o proveedor…"
        autocomplete="off"
        title="Buscar (Ctrl+K)" />
    </div>

    <!-- Segmento de vista -->
    <div class="segmented">
      <button type="button" class="seg" [class.active]="view() === 'activos'" (click)="goActivos()">
        Activos <span class="seg-badge">{{ activos().length }}</span>
      </button>
      <button type="button" class="seg" [class.active]="view() === 'cerrados'" (click)="goCerrados()">
        Cerrados <span class="seg-badge">{{ cerrados().length }}</span>
      </button>
      <button type="button" class="seg danger" [class.active]="view() === 'cancelados'" (click)="goCancelados()">
        Cancelados <span class="seg-badge">{{ cancelados().length }}</span>
      </button>
    </div>

    <!-- Acción principal -->
    <button class="primary" type="button" (click)="openCreate()" title="Nueva cotización (Ctrl+Shift+N)">
      <span class="material-icons" aria-hidden="true">add</span> Realizar cotización
    </button>
  </div>

  <!-- ====== LISTADO ====== -->
  <div class="card">
    <div class="table-wrapper" *ngIf="!loading(); else loadingTpl">
      <table class="grid" aria-label="Pedidos a proveedores">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Número</th>
            <th>Proveedor</th>
            <th class="mono">Subtotal</th>
            <th class="mono">Total</th>
            <th>Estado</th>
            <th class="acts-col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- filas -->
          <tr *ngFor="let p of paged(); trackBy: trackByPedidoId"
              [class.row-cerrado]="isEstado(p,'cerrado')"
              [class.row-cancelado]="isEstado(p,'cancelado')">
            <td>{{ asDate(p.fecha)?.toLocaleDateString() }}</td>
            <td class="strong">{{ p.numero || ('#'+p.id) }}</td>
            <td>{{ p.proveedorNombre }}</td>
            <td class="mono">Q {{ p.subtotal | number:'1.2-2' }}</td>
            <td class="mono">Q {{ p.total | number:'1.2-2' }}</td>
            <td>
              <span [ngClass]="estadoClass(p.estado)" class="pill">{{ estadoLabel(p.estado) }}</span>
            </td>
            <td>
              <div class="acts">
                <button class="icon" title="Enviar" *ngIf="isEstado(p,'borrador')" (click)="enviar(p)">
                  <span class="material-icons">send</span>
                </button>
                <button class="icon" title="Aprobar" *ngIf="isEstado(p,'enviado')" (click)="aprobar(p)">
                  <span class="material-icons">check_circle</span>
                </button>
                <button class="icon primary" title="Registrar recepción" *ngIf="isEstado(p,'aprobado','parcialmenterecibido')" (click)="openRecibir(p)">
                  <span class="material-icons">inventory_2</span>
                </button>
                <button class="icon" title="Ver detalle" *ngIf="isEstado(p,'cerrado')" (click)="verDetalle(p)">
                  <span class="material-icons">visibility</span>
                </button>
                <button class="icon danger"
                        [title]="isEstado(p,'parcialmenterecibido') ? 'Cancelar remanente pendiente' : 'Cancelar'"
                        *ngIf="isEstado(p,'borrador','enviado','aprobado','parcialmenterecibido')"
                        (click)="cancelar(p)">
                  <span class="material-icons">cancel</span>
                </button>
                <span class="no-actions" *ngIf="isEstado(p,'cancelado')">—</span>
              </div>
            </td>
          </tr>

          <!-- Vacío por vista -->
          <tr *ngIf="!loading() && listForView().length === 0">
            <td colspan="7" class="empty" aria-live="polite">
              <span class="material-icons">inbox</span>
              No hay pedidos que coincidan en esta vista
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #loadingTpl>
      <div class="empty"><div class="spinner"></div><span>Cargando…</span></div>
    </ng-template>

    <!-- Paginador -->
    <div class="pager" *ngIf="!loading() && totalItems() > 0">
      <div class="spacer"></div>
      <button class="ghost" type="button" [disabled]="!canPrev()" (click)="prev()">
        <span class="material-icons">chevron_left</span> Anterior
      </button>
      <button class="ghost" type="button" [disabled]="!canNext()" (click)="next()">
        Siguiente <span class="material-icons">chevron_right</span>
      </button>
    </div>
  </div>
</div>

<!-- ================= MODAL CREAR PEDIDO ================= -->
<section class="modal" *ngIf="showCreate" (click)="closeCreate()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <header class="modal-head">
      <div class="modal-title-wrap">
        <span class="modal-dot"></span>
        <h2>Nueva cotización</h2>
      </div>
      <div class="modal-actions">
        <button class="ghost small" type="button" (click)="openQuickAdd()" [disabled]="!proveedorId || quickSaving">
          <span class="material-icons" aria-hidden="true">add_box</span> Nuevo producto
        </button>
        <button class="icon close" type="button" (click)="closeCreate()" aria-label="Cerrar">
          <span class="material-icons">close</span>
        </button>
      </div>
    </header>

    <div class="modal-body">
      <form #fCrear="ngForm" (ngSubmit)="guardar(fCrear)" novalidate>
        <div class="form-row">
          <label>Proveedor *
            <select required [(ngModel)]="proveedorId" name="proveedorId" (ngModelChange)="cargarCatalogo()" title="Proveedor" [disabled]="cargandoCatalogo">
              <option [ngValue]="null" disabled>Seleccione un proveedor…</option>
              <option *ngFor="let p of proveedores; trackBy: trackByProveedorId" [ngValue]="p.id">{{ p.nombre }}</option>
            </select>
          </label>

          <label class="span-2">Observaciones
            <input [(ngModel)]="observaciones" name="observaciones" placeholder="Notas adicionales (opcional)" title="Observaciones del pedido" />
          </label>
        </div>

        <div class="catalog-head">
          <h3>Catálogo del proveedor</h3>
          <div class="search" aria-label="Buscar en catálogo">
            <span class="material-icons" aria-hidden="true">search</span>
            <input
              #catSearch
              [(ngModel)]="term" name="term" (ngModelChange)="buscarCatalogo()"
              placeholder="Buscar producto…"
              autocomplete="off"
              title="Buscar en catálogo"
              [disabled]="!proveedorId || cargandoCatalogo" />
          </div>
        </div>

        <div class="catalog-section">
          <div class="table-wrapper" *ngIf="proveedorId; else selectProviderTpl">
            <div *ngIf="cargandoCatalogo" class="empty">
              <div class="spinner small"></div>
              <span>Cargando catálogo…</span>
            </div>

            <table class="grid catalog-table" *ngIf="!cargandoCatalogo" aria-label="Catálogo">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="mono">Precio compra</th>
                  <th class="mono">Cantidad</th>
                  <th>Agregar</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let it of catalogo; trackBy: trackByCatalogoId">
                  <td class="strong">
                    <div style="display:flex;align-items:center;gap:12px;min-width:240px;">
                      <img
                        [src]="it.fotoUrl || placeholderImg"
                        alt="img"
                        loading="lazy"
                        style="width:42px;height:42px;border-radius:8px;object-fit:cover;border:1px solid #eee;"
                        (error)="onImgError($event)"
                      />
                      <div>{{ it.productoNombre }}</div>
                    </div>
                  </td>

                  <td class="mono">Q {{ (it.precioSugerido || 0) | number:'1.2-2' }}</td>

                  <td>
                    <div class="qty-stepper">
                      <button type="button" class="step" title="Restar 1" (click)="stepDown(qtyInput)">−</button>
                      <input
                        type="text"
                        #qtyInput
                        value="0"
                        class="qty-input"
                        title="Cantidad a agregar"
                        inputmode="numeric"
                        pattern="[0-9]*"
                        (input)="enforceInt(qtyInput)"
                        (blur)="enforceInt(qtyInput)"
                        (keydown.enter)="addLineaFrom(it, qtyInput)"
                        (keydown.arrowup)="stepUp(qtyInput)"
                        (keydown.arrowdown)="stepDown(qtyInput)"
                      />
                      <button type="button" class="step" title="Sumar 1" (click)="stepUp(qtyInput)">+</button>
                    </div>
                  </td>

                  <td>
                    <button
                      class="icon primary"
                      type="button"
                      title="Agregar al pedido"
                      (click)="addLineaFrom(it, qtyInput)"
                      [disabled]="(qtyInput.value || '0') === '0'">
                      <span class="material-icons">add_shopping_cart</span>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="!catalogo.length && !cargandoCatalogo">
                  <td colspan="4" class="empty">No hay productos en el catálogo de este proveedor</td>
                </tr>
              </tbody>
            </table>
          </div>

          <ng-template #selectProviderTpl>
            <div class="empty">
              <span class="material-icons">person</span>
              <p>Selecciona un proveedor para ver su catálogo</p>
            </div>
          </ng-template>
        </div>

        <div class="order-details">
          <h3 class="sub">Detalle de la cotización</h3>
          <div class="table-wrapper">
            <table class="grid order-table" aria-label="Detalle del pedido">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Presentación</th>
                  <th class="mono">Cantidad</th>
                  <th class="mono">Precio unitario</th>
                  <th class="mono">Total línea</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let l of lineas; let i = index; trackBy: trackByLineaId">
                  <td class="strong">{{ l.producto }}</td>
                  <td>{{ l.presentacion }}</td>
                  <td>
                    <input type="number" min="0.01" step="0.01" [(ngModel)]="l.cantidad" [name]="'cant' + i" (ngModelChange)="recalcLinea(l)" title="Cantidad" class="qty-input" />
                  </td>
                  <td class="mono">Q {{ l.precioUnitario | number:'1.2-2' }}</td>
                  <td class="mono">Q {{ l.totalLinea | number:'1.2-2' }}</td>
                  <td>
                    <button class="icon danger" type="button" (click)="eliminarLinea(i)" title="Eliminar línea">
                      <span class="material-icons">delete</span>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="!lineas.length">
                  <td colspan="6" class="empty">
                    <span class="material-icons">add_shopping_cart</span>
                    Agrega productos desde el catálogo
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="totals" *ngIf="lineas.length">
            
            <div>Total:</div>
            <div class="mono total-strong"> Q {{ total | number:'1.2-2' }}</div>
          </div>
        </div>

        <footer class="modal-foot">
          <button class="ghost" type="button" (click)="closeCreate()" [disabled]="guardando">Cancelar</button>
          <button class="primary" type="submit" [disabled]="guardando || !lineas.length || !proveedorId">
            <span *ngIf="guardando" class="material-icons spinning">hourglass_empty</span>
            {{ guardando ? 'Creando...' : 'Crear pedido' }}
          </button>
        </footer>
      </form>
    </div>
  </div>
</section>

<!-- ================= MODAL RECEPCIÓN ================= -->
<section class="modal" *ngIf="showRx" (click)="closeRx()">
  <div class="modal-card large" (click)="$event.stopPropagation()">
    <header class="modal-head">
      <div class="modal-title-wrap">
        <span class="modal-dot"></span>
        <h2>Recepción de compra {{ pedidoRx?.numero || ('#'+pedidoRx?.id) }}</h2>
      </div>
      <button class="icon close" type="button" (click)="closeRx()" aria-label="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </header>

    <div class="modal-body">
      <div class="reception-info">
        <div class="form-row reception">
          <label>Fecha de recepción *
            <input type="date" [(ngModel)]="rxFecha" title="Fecha de recepción" required />
          </label>
          <label>Número de compra
            <input [(ngModel)]="rxNumero" placeholder="Número de factura (opcional)" title="Número del documento de compra" />
          </label>
          <label>Forma de pago *
            <select [(ngModel)]="rxFormaPagoId" title="Forma de pago" required>
              <option [ngValue]="null" disabled>Seleccione forma de pago…</option>
              <option *ngFor="let fp of formasPago; trackBy: trackByFormaPagoId" [ngValue]="fp.id">{{ fp.nombre }}</option>
            </select>
          </label>
        </div>

        <div class="form-row" *ngIf="rxFormaPagoRequiereRef">
          <label class="span-2">Referencia de depósito/transferencia *
            <input [(ngModel)]="rxReferencia" placeholder="Ej. 2048896268 / número de boleta o transferencia" />
          </label>
        </div>
      </div>

      <div class="reception-details">
        <h3>Productos a recibir</h3>
        <div class="card">
          <div class="table-wrapper">
            <table class="grid reception-table" aria-label="Recepción de líneas">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Presentación</th>
                  <th class="mono">Pedida</th>
                  <th class="mono">Recibida</th>
                  <th class="mono">Pendiente</th>
                  <th class="mono">Recibir ahora</th>
                  <th class="mono">Costo unitario</th>
                  <th class="mono">Total línea</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of rxRows; trackBy: trackByRxRowId">
                  <td class="strong">{{ r.producto }}</td>
                  <td>{{ r.presentacion }}</td>
                  <td class="mono">{{ r.pedida | number:'1.2-2' }}</td>
                  <td class="mono">{{ r.recibida | number:'1.2-2' }}</td>
                  <td class="mono">{{ r.pendiente | number:'1.2-2' }}</td>
                  <td>
                    <input type="number" min="0" step="0.01" [(ngModel)]="r.recibirAhora" (ngModelChange)="rxRecalcRow(r)" title="Cantidad a recibir ahora" class="qty-input" [max]="r.pendiente" />
                  </td>
                  <td class="mono">Q {{ r.costoUnitario | number:'1.2-2' }}</td>
                  <td class="mono">Q {{ (r.recibirAhora * r.costoUnitario) | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="totals reception-totals">
            <div>Subtotal de recepción:</div>
            <div class="mono">Q {{ rxSubtotal | number:'1.2-2' }}</div>
            <div>Total de recepción:</div>
            <div class="mono total-strong">Q {{ rxTotal | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="modal-foot">
      <button class="ghost" type="button" (click)="closeRx()">Cancelar</button>
      <button class="primary" type="button" [disabled]="!rxHayAlgo || !rxFormaPagoId || (rxFormaPagoRequiereRef && !rxReferencia)" (click)="confirmarRecepcion()">
        <span class="material-icons">inventory_2</span> Registrar recepción
      </button>
    </footer>
  </div>
</section>

<!-- ============ SUB-MODAL: NUEVO PRODUCTO RÁPIDO ============ -->
<section class="modal sub-modal" *ngIf="showQuick" (click)="closeQuickAdd()">
  <div class="modal-card small" (click)="$event.stopPropagation()">
    <header class="modal-head">
      <div class="modal-title-wrap">
        <span class="modal-dot"></span>
        <h2>Nuevo producto</h2>
      </div>
      <button class="icon close" type="button" (click)="closeQuickAdd()" aria-label="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </header>

    <div class="modal-body">
      <div class="form-row quick">
        <label>Nombre *
          <input [(ngModel)]="qp.nombre" placeholder="Nombre del producto" />
        </label>
        <label>Categoría *
          <select [(ngModel)]="qp.categoriaId">
            <option [ngValue]="null" disabled>Seleccione…</option>
            <option *ngFor="let c of categorias; trackBy: trackByCategoriaId" [ngValue]="c.id">{{ c.nombre }}</option>
          </select>
        </label>
        <label>Proveedor *
          <select [(ngModel)]="qp.proveedorId">
            <option *ngFor="let p of proveedores; trackBy: trackByProveedorId" [ngValue]="p.id">{{ p.nombre }}</option>
          </select>
        </label>
      </div>

      <div class="form-row quick">
        <label>Precio compra por defecto
          <input type="number" min="0" step="0.01" [(ngModel)]="qp.precioCompraDefault" class="price-input" />
        </label>
        <label>Precio venta por defecto
          <input type="number" min="0" step="0.01" [(ngModel)]="qp.precioVentaDefault" class="price-input" />
        </label>
        <label>Activo
          <select [(ngModel)]="qp.activo">
            <option [ngValue]="true">Sí</option>
            <option [ngValue]="false">No</option>
          </select>
        </label>
      </div>

      <div class="uploader" (drop)="onQuickDrop($event)" (dragover)="$event.preventDefault()">
        <span class="material-icons">upload</span>
        <div>
          <p>Arrastra una imagen aquí o</p>
          <label class="ghost small" style="cursor:pointer">
            <input type="file" accept="image/*" (change)="onQuickFile($event)" hidden />
            Selecciona un archivo
          </label>
        </div>
        <img *ngIf="qp.fotoUrl" [src]="qp.fotoUrl" alt="preview"/>
      </div>
    </div>

    <footer class="modal-foot">
      <button class="ghost" type="button" (click)="closeQuickAdd()">Cancelar</button>
      <button class="primary" type="button" [disabled]="quickSaving" (click)="quickCreate()">
        <span *ngIf="quickSaving" class="material-icons spinning">hourglass_empty</span>
        {{ quickSaving ? 'Creando…' : 'Crear producto' }}
      </button>
    </footer>
  </div>
</section>

<!-- ============ MODAL: VER DETALLE ============ -->
<section class="modal" *ngIf="showView" (click)="closeView()">
  <div class="modal-card large" (click)="$event.stopPropagation()">
    <header class="modal-head">
      <div class="modal-title-wrap">
        <span class="modal-dot"></span>
        <h2>Detalle de la compra {{ pedidoView?.numero || ('#' + pedidoView?.id) }}</h2>
      </div>
      <button class="icon close" type="button" (click)="closeView()" aria-label="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </header>

    <div class="modal-body" *ngIf="pedidoView as v">
      <div class="form-row">
        <label>Proveedor</label>
        <div class="strong">{{ v.proveedorNombre }}</div>

        <label>Fecha</label>
        <div>{{ asDate(v.fecha)?.toLocaleString() }}</div>

        <label>Estado</label>
        <div><span [ngClass]="estadoClass(v.estado)" class="pill">{{ estadoLabel(v.estado) }}</span></div>
      </div>

      <div class="form-row">
        <label class="span-2">Observaciones</label>
        <div class="span-2">{{ v.observaciones || '—' }}</div>
      </div>

      <div class="form-row">
        <label>Forma de pago</label>
        <div>{{ v.formaPago || '—' }}</div>
      </div>

      <div class="table-wrapper">
        <table class="grid" aria-label="Detalle de líneas">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Presentación</th>
              <th class="mono">Cantidad</th>
              <th class="mono">Recibida</th>
              <th class="mono">Precio unitario</th>
              <th class="mono">Total línea</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of v.detalles">
              <td class="strong">{{ d.productoNombre }}</td>
              <td>{{ d.presentacionNombre }} <span class="unit">({{ d.unidad }})</span></td>
              <td class="mono">{{ d.cantidad | number:'1.2-2' }}</td>
              <td class="mono">{{ d.cantidadRecibida | number:'1.2-2' }}</td>
              <td class="mono">Q {{ d.precioUnitario | number:'1.2-2' }}</td>
              <td class="mono">Q {{ d.totalLinea | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="totals">
        <div>Subtotal:</div>
        <div class="mono">Q {{ v.subtotal | number:'1.2-2' }}</div>
        <div>Descuento:</div>
        <div class="mono">Q {{ v.descuento | number:'1.2-2' }}</div>
        <div>Total:</div>
        <div class="mono total-strong">Q {{ v.total | number:'1.2-2' }}</div>
      </div>
    </div>

    <footer class="modal-foot">
      <button class="primary" type="button" (click)="closeView()">Cerrar</button>
    </footer>
  </div>
</section>
